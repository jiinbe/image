<!doctype html>
<html>
<head>
<title>Example Picture Overlay</title>

<meta charset="utf-8" />
<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<!--<meta name="viewport" content="width=device-width, initial-scale=1" />-->
<link rel="stylesheet" href="app.css">
<style>
.draggable {
top:110;
position: absolute;
z-index: 100;

/*background: #cddc39;*/
border-radius: 8px;
cursor: url(../../packages/dnd/cursor/openhand.cur), move; /* Cursor for IE. */
cursor: url(../../packages/dnd/cursor/openhand.cur) 7 5, move; /* Cursor for FF and Chrome (setting midpoint). */
}

.draggable p {
text-align: center;
font-weight: bold;
}

.dropzone-outer {
	  
height: auto;
padding: 10px;
margin-top: 20px;
border: solid 1px red;
/* background: #ffc107;*/
border-radius: 8px;
}

.dropzone-inner {
padding: 10px;

	 
border-radius: 8px;
background-color: #ffe082;
}

.dnd-draggable, .dnd-drag-occurring {
cursor: url(../../packages/dnd/cursor/closedhand.cur), move; /* Cursor for IE. */
cursor: url(../../packages/dnd/cursor/closedhand.cur) 7 5, move; /* Cursor for FF and Chrome (setting midpoint). */
}

.dnd-dragging {
opacity: 0.7;
}

.dnd-over {
/*background-color: #ff5722;*/
}

#create_photo{
max-height: auto;
text-align: center;
}
</style>
<script src="http://code.jquery.com/jquery-1.10.2.js"></script>
<script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<script src="https://rawgit.com/eligrey/FileSaver.js/master/FileSaver.js"></script>
<script src ="https://rawgit.com/eligrey/canvas-toBlob.js/master/canvas-toBlob.js"></script>
</head>

<body>
<main>
<h1>Example Overlay</h1>
<p class="box">
<img id="febric" src="placeholder.png"/>
<img id="photo" src="overlay.png"/>
<canvas width="600" height="600" id="can"></canvas>
</p>
  
<p><span id="status"></span></p> 
<p><label>Avatar:</label> <input accept="image/*" type='file' id="backimg" oninput="checkInput()" /></p>
<p><label>Frame:</label> <input accept="image/*" type='file' id="photoimg" oninput="checkInput()" /></p>

<p>
<button id="save">Download</button>
</p>
</main>
<script src="app.js"></script>
<script>
var origin_w2;
var origin_h2;
	
function readURL_Photo(input) {

if (input.files && input.files[0]) {
var reader = new FileReader();

/*reader.onload = function (e) {
$('#photo').attr('src', e.target.result);
				
}*/
reader.onload = (function(theFile) { 
var image = new Image();
image.src = theFile.target.result;

image.onload = function() {
// access image size here 
origin_w2=this.width;
origin_h2=this.height;
console.log(origin_w2);
$('#photo').attr('src', this.src);
					
};
});
			
			
			
			
reader.readAsDataURL(input.files[0]);
}
}

$("#photoimg").change(function(){
readURL_Photo(this);
});
//febric image insert
	
function readURL_Back(input) {

if (input.files && input.files[0]) {
var reader = new FileReader();

reader.onload = function (e) {
$('#febric').attr('src', e.target.result);
$('label[for=shot]').css('display','none');
}

reader.readAsDataURL(input.files[0]);
}
}

$("#backimg").change(function(){
readURL_Back(this);
});
// photo drag and drop
$(function() 
{
$( "#photo" ).draggable({});
});
$(document).ready(function() {
$(".draggable").draggable({ 
containment: '', 
scroll: false
}).mousemove(function(){
var coord = $(this).position();
var width = $(this).width();
var height = $(this).height();
$("p.position").text( "(" + coord.left + "," + coord.top + ")" );
console.log(coord.top(),coord.left(),coord.width(),coord.height())
$("p.size").text( "(" + width + "," + height + ")" );
}).mouseup(function(){
var coord = $(this).position();
var width = $(this).width();
var height = $(this).height();
               
               
});
});
	
//zoon in and out
var myimage = document.getElementById("photo");
if (myimage.addEventListener) {
// IE9, Chrome, Safari, Opera
myimage.addEventListener("mousewheel", MouseWheelHandler, false);
// Firefox
myimage.addEventListener("DOMMouseScroll", MouseWheelHandler, false);
}
// IE 6/7/8
else myimage.attachEvent("onmousewheel", MouseWheelHandler);

function MouseWheelHandler(e) {
// cross-browser wheel delta
e.preventDefault();
var e = window.event || e; // old IE support
var delta = Math.max(-1, Math.min(1, (e.wheelDelta || -e.detail)));
myimage.style.width = Math.max(50, Math.min(800, myimage.width + (30* delta))) + "px";
//myimage.style.height = Math.max(50, Math.min(800, myimage.height + (30 *myimage.width/myimage.height * delta))) + "px";
//alert(myimage.offsetTop);
return false;
}
	
//Create new image
$("#save").click(function(){
//alert();
			
var c = document.getElementById('can');
var ctx=c.getContext("2d");
//ctx.drawImage(null);
var image1 = document.getElementById("febric");
var w1=image1.clientWidth;
var h1=image1.clientHeight;
var t1=image1.offsetTop;
var l1=image1.offsetLeft;
console.log(image1, l1, t1, w1, h1);
			
			
var image2 = document.getElementById("photo");
var w2=image2.clientWidth;
var h2=image2.clientHeight;
var t2=image2.offsetTop;
var l2=image2.offsetLeft;
console.log(image2, l2, t2, w2, h2);
			
ctx.fillStyle = "#CCCCCC";
ctx.drawImage(image1, l2, t2, w2, h2 ,0,0,origin_w2,origin_h2);   
//context.drawImage(img,sx,sy,swidth,sheight,x,y,width,height);
			
ctx.drawImage(image2, 0, 0, origin_w2,origin_h2,0,0,origin_w2,origin_h2);      
var img = c.toDataURL("image/png");      
var new_html =$('<div id="create_photo"><img src="' + img + '" width="'+origin_w2+'" height="'+origin_h2+'" style="border:solid 1px gray"/>'+
'<div style="margin-top:10px"><input type="button" value="Download" onclick="download();" id="save"/>'+
'<input type="button" value="Back" onclick="location.reload();" /></div></div>'); 
				
$(".container #create_photo").remove();
$(".container").append(new_html);
			
});
//
function download(){
var canvas = document.getElementById("can");
canvas.toBlob(function(blob) {
saveAs(blob, "output.png");
}, "image/png");
}

</script>
</body>
</html>
