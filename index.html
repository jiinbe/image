<!doctype html>
<html>
<head>
<title>Example Picture Overlay</title>

<meta charset="utf-8" />
<!--
<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
-->
<link rel="stylesheet" href="app.css">
<style>
</style>
<script src="https://jiinbe.github.io/picture/app/jquery.min.js"></script>
<script src="https://jiinbe.github.io/picture/app/fabric.min.js"></script>
<script src="https://jiinbe.github.io/picture/app/FileSaver.js"></script>
<script src="https://jiinbe.github.io/picture/app/canvas-toBlob.js"></script></head>

<body>
<main>
<h1>Example Overlay</h1>
<p class="box">
<canvas id="imageCanvas"></canvas> 
</p>

<p>
<input type="file" id="imageLoader" accept="image/*" hidden/>
<input type="file" id="iimageLoader" accept="image/*" hidden/>
</p>

<p>
<label for="imageLoader">Pilih Foto</label>
<label for="iimageLoader">Pilih Bingkai</label>
<label id="delete">Hapus Foto</label>
</p>

<p><a href="#" id="lnkDownload">Save image</a></p>
</main>
<script>
var canvas = new fabric.Canvas('imageCanvas', {
backgroundColor: 'rgb(240,240,240)'
});
  
fabric.Object.prototype.transparentCorners = false;
fabric.Object.prototype.originX = fabric.Object.prototype.originY = 'center';
  
canvas.selection = false;
canvas.setWidth(600);
canvas.setHeight(600);

var imageLoader = document.getElementById('imageLoader');
imageLoader.addEventListener('change', handleImage, false);

function handleImage(e) {
var objects = canvas.getObjects();
for (var i in objects) {
objects[i].remove();
}
var reader = new FileReader();
reader.onload = function(event) {
var img = new Image();
img.onload = function() {
var imgInstance = new fabric.Image(img, {
selectable: 1,
// width: 600,
// height: 600,
// borderColor: 'black',
cornerColor: 'black',
cornerSize: 30,
// padding: 20,
// transparentCorners: true
})
canvas.add(imgInstance);
/* var red = new fabric.Rect({ width: 600, height: 600, fill: 'red'})
canvas.add(red);
red.center(); */
canvas.deactivateAll().renderAll();
}

var iimageLoader = document.getElementById('iimageLoader');
iimageLoader.addEventListener('change', handleImage, false);

function handleImage(f) {
var objects = canvas.getObjects();
/* for (var i in objects) {
objects[i].remove();
} */
var reader = new FileReader();
reader.onload = function(event) {

var fimg = new Image();
fimg.onload = function() {
var fimgInstance = new fabric.Image(fimg, {
selectable: 0,
width: 600,
height: 600
})
canvas.add(fimgInstance);
fimgInstance.center();
/* var red = new fabric.Rect({ width: 600, height: 600, fill: 'red'})
canvas.add(red);
red.center(); */
canvas.deactivateAll().renderAll();
}
fimg.src = event.target.result;
}
reader.readAsDataURL(f.target.files[0]);
}

img.src = event.target.result;

}
reader.readAsDataURL(e.target.files[0]);
}

canvas.on({
'object:moving': function(e) {
e.target.opacity = 0.5;
},
'object:modified': function(e) {
e.target.opacity = 1;
}
});


var font = new fabric.Text('HELLO WORLD!', { 
fill: 'black' 
}); 
 
// Render the text on Canvas 
canvas.add(font); 
canvas.centerObject(font);
  
var imageSaver = document.getElementById('lnkDownload');
imageSaver.addEventListener('click', saveImage, false);
  
function saveImage(e,f) {
this.href = canvas.toDataURL({
format: 'png',
quality: 0.8
});
this.download = 'canvas.png'
}


fabric.Object.prototype.drawControls = function(ctx, styleOverride) {
styleOverride = styleOverride || {};
var wh = this._calculateCurrentDimensions(),
width = wh.x,
height = wh.y,
scaleOffset = styleOverride.cornerSize || this.cornerSize,
left = -(width + scaleOffset) / 2,
top = -(height + scaleOffset) / 2,
transparentCorners = typeof styleOverride.transparentCorners !== 'undefined' ?
styleOverride.transparentCorners : this.transparentCorners,
hasRotatingPoint = typeof styleOverride.hasRotatingPoint !== 'undefined' ?
styleOverride.hasRotatingPoint : this.hasRotatingPoint,
methodName = transparentCorners ? 'stroke' : 'fill';
ctx.save();
ctx.strokeStyle = ctx.fillStyle = styleOverride.cornerColor || this.cornerColor;
if (!this.transparentCorners) {
ctx.strokeStyle = styleOverride.cornerStrokeColor || this.cornerStrokeColor;
}
this._setLineDash(ctx, styleOverride.cornerDashArray || this.cornerDashArray, null);
// top-left
const cancel = new Image()
cancel.src = 'https://upload.wikimedia.org/wikipedia/commons/6/65/Crystal_button_cancel.svg'
ctx.drawImage(cancel, left, top, this.cornerSize, this.cornerSize)
// top-right
this._drawControl('tr', ctx, methodName,
left + width,
top, styleOverride);
// bottom-left
this._drawControl('bl', ctx, methodName,
left,
top + height, styleOverride);
// bottom-right
this._drawControl('br', ctx, methodName,
left + width,
top + height, styleOverride);
if (!this.get('lockUniScaling')) {
// middle-top
this._drawControl('mt', ctx, methodName,
left + width / 2,
top, styleOverride);
// middle-bottom
this._drawControl('mb', ctx, methodName,
left + width / 2,
top + height, styleOverride);
// middle-right
this._drawControl('mr', ctx, methodName,
left + width,
top + height / 2, styleOverride);
// middle-left
this._drawControl('ml', ctx, methodName,
left,
top + height / 2, styleOverride);
}
// middle-top-rotate
if (hasRotatingPoint) {
this._drawControl('mtr', ctx, methodName,
left + width / 2,
top - this.rotatingPointOffset, styleOverride);
}
ctx.restore();
return this;
},

fabric.Canvas.prototype._getActionFromCorner = function(target, corner, e) {
if (!corner) {
return 'drag';
}
switch (corner) {
case 'mtr':
return 'rotate';
case 'ml':
break;
case 'mr':
return e[this.altActionKey] ? 'skewY' : 'scaleX';
case 'mt':
case 'mb':
return e[this.altActionKey] ? 'skewX' : 'scaleY';
case 'tl': // 增加左上刪除動作
canvas.remove(target)
return 'deleted'
default:
return 'scale';
}
}
</script>
<!--
<script>
$("#delete").click(function(){
canvas.isDrawingMode = false;
deleteObjects();
});

function deleteObjects(){
var activeObject = canvas.getActiveObject(),
activeGroup = canvas.getActiveGroup();
if (activeObject) {
if (confirm('Are you sure?')) {
canvas.remove(activeObject);
}
}
else if (activeGroup) {
if (confirm('Are you sure?')) {
var objectsInGroup = activeGroup.getObjects();
canvas.discardActiveGroup();
objectsInGroup.forEach(function(object) {
canvas.remove(object);
});
}
}
}
</script>
-->
</body>
</html>
